@using NewCrmCore.Infrastructure.CommonTools
@{
	Layout = "~/Views/Shared/_LayoutRoot.cshtml";
}

@section ChildrenCss
{	
	<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
	<style>
		body {
			margin: 10px 10px 0;
		}

		.membericon {
			width: 24px;
			height: 24px;
		}

		.membername {
			margin-left: 10px;
		}
		
	</style>
}
@section SysCss
{
	<link rel="stylesheet" href="/css/hoorayui/sys.css" />
}

<div  style="margin-bottom:10px;background-color:#f5f5f5;border:1px solid #e3e3e3;min-height:20px;padding:9px">
	<div class="form-inline">
		<div class="form-group">
			<label>账户名：</label>
			<input type="text" name="userName" class="form-control" id="userName" class="span2">
		</div>

		<div class="form-group">
			<label style="margin-left:10px">账户类型：</label>
			<select name="userType" id="userType" class="form-control" style="width: 150px">
				<option value="">全部</option>
				<option value="1">账户</option>
				<option value="2">管理员</option>
			</select>
		</div>
		<a class="btn btn-primary" menu="search" href="###" style="margin-left:10px"><i class="oi oi-magnifying-glass"></i> 搜索</a>
		<a class="btn btn-primary ml-auto" href="javascript:openDetailIframe('/usermanager/user');" ><i class="oi oi-plus"></i> 添加新账户</a>
	</div>
</div>
<table class="list-table">
	<thead>
		<tr class="col-name">
			<th>账户名</th>
			<th style="width: 100px">类型</th>
			<th style="width: 150px">操作</th>
		</tr>
		<tr class="sep-row"><td colspan="100"></td></tr>
		<tr class="toolbar">
			<td colspan="100">
				<b style="margin: 0 10px">符合条件的记录</b>有<font class="list-count">0</font>条
			</td>
		</tr>
		<tr class="sep-row"><td colspan="100"></td></tr>
	</thead>
	<tbody class="list-con"></tbody>
	<tfoot>
		<tr>
			<td colspan="100">
				<div style="margin:20px 0" id="pagination"></div>
				<input id="pagination_setting" type="hidden" per="15">
			</td>
		</tr>
	</tfoot>
</table>

<div id="detailIframe" style="background:#fff;position:fixed;z-index:1;top:-100px;left:0;width:100%;height:100%;display:none">
	<iframe frameborder="0" style="width:100%;height:100%"></iframe>
</div>
@section ChildrenTemplate{
	<script id="table-template" type="text/x-handlebars-template">
		{{#each Model}}
		<tr class="list-bd">
			<td style="text-align:left;padding-left:15px;width:33%">
				<img src="{{UserFace}}" alt="{{Name}}" class="membericon">
				<span class="membername">{{Name}}</span>
			</td>
			<td style="text-align:left;padding-left:15px;width:33%">{{convertUserType IsAdmin}}</td>
			<td style="width:33%">
				<a href="javascript:openDetailIframe('/usermanager/user?userId={{Id}}');" class="btn btn-link">编辑</a>
				<a href="javascript:void(0);" class="btn btn-link do-del" memberid="{{Id}}" >删除</a>
				{{#if IsDisable}}
					<a href="javascript:void(0);" class="btn btn-link do-disable" isDisable="false" memberid="{{Id}}">启用</a>
				{{else}}
					<a href="javascript:void(0);" class="btn btn-link do-disable" isDisable="true" memberid="{{Id}}">禁用</a>
				{{/if}}
			</td>
		</tr>
		{{/each}}
	</script>
}
@section ChildrenScript
{
	//加载列表
	getPageList(0);
	//删除
	$('.list-con').on('click', '.do-del', function () {
		let memberid = $(this).attr('memberid');
		let name = $(this).parent().prev().text();
		art.dialog({
			id: 'edit',
			content: '确定要删除 “' + name + '” 该账户么？',
			ok: function () {
				HROS.request.post('/usermanager/removeuser', { userId: memberid}, function (responseText) {
					if (responseText.IsSuccess) {
						$('#pagination').trigger('currentPage');
					} else {
						NewCrm.msgbox.fail(responseText.Message);
					}
				});
			},
			cancel: true
		});
	});

	$('.list-con').on('click', '.do-disable', function () {
		let memberid = $(this).attr('memberid');
		let name = $(this).parent().prev().text();
		let isDisable = $(this).attr('isDisable');
		art.dialog({
			id: 'edit',
			content: isDisable ? '确定要启用 “' + name + '” 该账户么？' : '确定要禁用 “' + name + '” 该账户么？',
			ok: function () {
				let url = '';
				if (isDisable) {
					url = '/usermanager/disable';
				} else {
					url = '/usermanager/enable';
				}
				HROS.request.post(url, { userId: parseInt(memberid) }, function (responseText) {
					if (responseText.IsSuccess) {
						$('#pagination').trigger('currentPage');
					} else {
						NewCrm.msgbox.fail(responseText.Message);
					}
				});
			},
			cancel: true
		});
	});

	//搜索
	$('a[menu=search]').click(function () {
		getPageList(0);
	});

	function getPageList(current_page) {
		HROS.request.get('/usermanager/users', {
			userName: $('#userName').val(),
			userType: $('#userType').val(),
			pageIndex: current_page === 0 ? 1 : current_page + 1,
			pageSize: 5
		}, function (responseText) {
			if (responseText.IsSuccess) {
				let tableTemplate = Handlebars.compile($("#table-template").html());
				$('.list-con').html(tableTemplate(responseText));
				$('#pagination_setting').attr('count', responseText.TotalCount);
				$('.list-count').text(responseText.TotalCount);
				initPagination({
					current_page: current_page,
					items_per_page: 5,
					num_display_entries: 3,
					num_edge_entries: 1,
					getPageList: getPageList
				})

			} else {
				NewCrm.msgbox.fail(responseText.Message);
			}
		});
	}

	Handlebars.registerHelper('convertUserType', function (isAdmin) {
		if (isAdmin) {
			return '管理员账户';
		} else {
			return '普通账户';
		}
	});
}
