<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="http://cdn.bootcss.com/font-awesome/4.6.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/message.css">
</head>

<body>
    <div class="notifyList"></div>
</body>

</html>
<script src="js/jquery.min.js"></script>
<script src="js/message.js"></script>
<script src="/js/signalr/signalr.min.js"></script>
<script>
    $(function () {
        initMessagePlugin()
    })

    function initData() {
        return new Promise((resolve, reject) => {
            top.HROS.request.get('/desk/checkunreadnotifycount', { pageIndex: 1, pageSize: 100 }, function (responseText) {
                if (responseText.IsSuccess) {
                    var models = responseText.Model.Models
                    var msgArr = []
                    for (let index = 0; index < models.length; index++) {
                        msgArr.push({ text: models[index].Content, id: models[index].Id, readStatus: models[index].IsRead ? 1 : 0 })
                    }
                    resolve(msgArr)
                } else {
                    NewCrm.msgbox.fail(responseText.Message);
                }
            })
        });
    }
    function initMessagePlugin() {
        initData().then((msgArr) => {
            var notify = MessagePlugin.init({
                elem: ".notifyList",
                noticeData: msgArr,
                noticeUnReadData: msgArr.filter((a) => a.readStatus === 0).length,
                noticeClick: function (obj) {
                    top.HROS.request.post('/desk/readnotify', { notifyId: $(obj).prop('id') }, function (responseText) {
                        if (responseText.IsSuccess) {
                            initMessagePlugin()
                        } else {
                            top.NewCrm.msgbox.fail(responseText.Message)
                        }
                    })
                },
                allRead: function (obj) {
                    top.NewCrm.msgbox.fail('开发中...')
                },
                getNodeHtml: function (obj, node) {
                    node.isRead = obj.readStatus == 1
                    node.html = "<p>" + obj.text + "</p>";
                    return node;
                }
            })
            initSignalR(notify)
        })
    }
    function initSignalR(notify) {
        var connection = new signalR.HubConnectionBuilder().withUrl("/hubs?accountId=" + top.HROS.CONFIG.memberID).configureLogging(signalR.LogLevel.Information).build();
        connection.on("Message", (responseText) => {
            var message = JSON.parse(responseText)
            notify.messageNotify(message.Title, message.Content)
        });
        connection.start().then(() => {
            connection.invoke('RegisterConnection').then((result) => {
                connectionId = result;
            }).catch(err => NewCrm.msgbox.fail('推送服务注册失败:' + err));
        }).catch(err => NewCrm.msgbox.fail('推送服务连接失败'));
    }
</script>