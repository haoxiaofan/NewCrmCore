<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/message.css">
</head>

<body>
    <div class="notifyList"></div>
</body>

</html>
<script src="js/jquery.min.js"></script>
<script src="js/message.js"></script>
<script>
    $(function () {
        initMessagePlugin()
    })

    function initData() {
        return new Promise((resolve, reject) => {
            $.get('/desk/checkunreadnotifycount', { pageIndex: 1, pageSize: 100 }, function (responseText) {
                if (responseText.IsSuccess) {
                    let models = responseText.Model.Models
                    let msgArr = []
                    for (let index = 0; index < models.length; index++) {
                        msgArr.push({ text: models[index].Content, id: models[index].Id, readStatus: models[index].IsRead ? 1 : 0 })
                    }
                    resolve(msgArr)
                }
            })

        });
    }
    function initMessagePlugin() {
        initData().then((msgArr) => {
            let notify = MessagePlugin.init({
                elem: ".notifyList",
                msgData: msgArr,
                msgUnReadData: msgArr.filter((a) => a.readStatus === 0).length,
                msgClick: function (obj) {
                    $.post('/desk/readnotify', { notifyId: $(obj).prop('id') }, function (responseText) {
                        if (responseText.IsSuccess) {
                            initMessagePlugin()
                        }
                    })

                },
                allRead: function (obj, t) {
                    let ids = t.nodeList.filter((n) => !n.isRead).map(s => s.id);
                    $.post('/desk/readnotify', { notifyId: ids.join() }, function (responseText) {
                        if (responseText.IsSuccess) {
                            initMessagePlugin()
                        }
                    })

                },
                getNodeHtml: function (obj, node) {
                    node.isRead = obj.readStatus == 1
                    node.html = "<p>" + obj.text + "</p>";
                    return node;
                }
            })
        })
    }

</script>